<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Barcode + QR Generator</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #9fa8b3, #5c6670);
    color: #fff;
    padding: 30px;
  }
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }
  body.popup-open {
    overflow: hidden;
  }
  .container {
    max-width: 520px;
    margin: auto;
    background: rgba(255,255,255,0.08);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(6px);
  }
  select, input {
    width: 100%;
    padding: 11px;
    margin: 10px 0;
    border-radius: 6px;
    border: none;
  }
  button {
    width: 100%;
    padding: 12px;
    background: #2d3136;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
  }
  #output img {
    margin-top: 15px;
    padding: 12px;
    background: #fff;
    border-radius: 8px;
  }
  #output {
    text-align: center;
    margin-top: 20px;
  }

  /* CODE ROW */
.code-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  width: 100%;
}

.code-row input {
  grid-column: 1 / 3; /* input occupies full width */
}

.code-row .small-btn {
  width: 100%;
  padding: 10px;
  font-size: 15px;
}

  /* Spinner */
  .spinner {
    display: none;
    margin: 10px auto;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    100% { transform: rotate(360deg); }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

<div class="container">
  <h2 style="line-height: 1.3;">
    <span style="font-size: 32px; font-weight: bold;">Barcode Generator</span><br>
    <span style="font-size: 18px; opacity: 0.9;">RJ Bana Store</span>
  </h2>

  <input type="text" id="label" placeholder="Enter Item Label (optional)" maxlength="24" />

  <select id="type">
    <option value="barcode">Barcode</option>
    <option value="qrcode">QR Code</option>
  </select>

  <select id="digitLength">
    <option value="6">Generate 6 Digits</option>
    <option value="8" selected>Generate 8 Digits</option>
    <option value="10">Generate 10 Digits</option>
    <option value="12">Generate 12 Digits</option>
  </select>

  <!-- fixed code-row -->
  <div class="code-row">
    <input type="text" id="code" placeholder="Enter Code Number" maxlength="12" />
    <button class="small-btn" onclick="autoFillCode()">Auto</button>
    <button class="small-btn" onclick="copyCode()">Copy</button>
  </div>

  <input type="number" id="barcodeHeight" placeholder="Barcode Height (30–150, default 60)" />

  <button onclick="generate()">Generate</button>
  <button id="btnImg" onclick="downloadImage()" disabled>Download Image</button>
  <button id="btnPdf" onclick="downloadPDF()" disabled>Download PDF</button>
  <button onclick="clearAll()">Clear</button>

  <div class="spinner" id="spinner"></div>
  <div id="output"></div>
</div>

<script>
let generatedImg = null;
let pressedImg = null;

/* AUTO GENERATE */
function autoFillCode() {
  const len = parseInt(document.getElementById("digitLength").value);
  const min = 10 ** (len - 1);
  const max = 10 ** len - 1;
  const code = Math.floor(Math.random() * (max - min + 1)) + min;
  document.getElementById("code").value = code;
}

/* COPY */
function copyCode() {
  const code = document.getElementById("code").value.trim();
  if (!code) return alert("No code to copy!");
  navigator.clipboard.writeText(code);
  alert("Copied!");
}

/* VALIDATION */
function validateCode(code) {
  return /^[0-9]{6}$/.test(code) ||
         /^[0-9]{8}$/.test(code) ||
         /^[0-9]{10}$/.test(code) ||
         /^[0-9]{12}$/.test(code);
}

/* CLEAR */
function clearAll() {
  document.getElementById("code").value = "";
  document.getElementById("label").value = "";
  document.getElementById("output").innerHTML = "";
  generatedImg = null;
  enableDownloadButtons();
}

function enableDownloadButtons() {
  const disable = !generatedImg;
  document.getElementById("btnImg").disabled = disable;
  document.getElementById("btnPdf").disabled = disable;
}

/* Spinner */
function showSpinner() { document.getElementById("spinner").style.display = "block"; }
function hideSpinner() { document.getElementById("spinner").style.display = "none"; }

/* GENERATE */
function generate() {
  const type = document.getElementById("type").value;
  const label = document.getElementById("label").value.trim();
  const code = document.getElementById("code").value.trim();

  if (!validateCode(code)) {
    alert("Code must be 6, 8, 10, or 12 digits only.");
    return;
  }

  document.getElementById("output").innerHTML = "";
  generatedImg = null;
  enableDownloadButtons();

  showSpinner();

  setTimeout(() => {
    if (type === "barcode") generateBarcode(code, label);
    else generateQR(code, label);
  }, 50);
}

/* BARCODE */
function generateBarcode(code, label) {

  // Step 1 — safe barcode height
  const userHeight = parseInt(document.getElementById("barcodeHeight").value);
  const barcodeHeight = Math.min(150, Math.max(30, userHeight || 60));

  // Step 2 — safe spacing so nothing overlaps
  const topPadding = label ? 32 : 15;     // label area
  const bottomPadding = 32;               // number area
  const totalHeight = topPadding + barcodeHeight + bottomPadding;

  // Step 3 — High DPI canvas for clear lines
  const scale = 2;
  const canvas = document.createElement("canvas");
  canvas.width = 420 * scale;             // wide enough for long barcodes
  canvas.height = totalHeight * scale;

  const ctx = canvas.getContext("2d");
  ctx.scale(scale, scale);

  // Step 4 — generate barcode in temp canvas
  const barcodeCanvas = document.createElement("canvas");
  JsBarcode(barcodeCanvas, code, {
    format: "CODE128",
    displayValue: false,
    height: barcodeHeight,
    width: 2,                    // consistent bar width
    margin: 0
  });

  // Step 5 — center barcode horizontally
  const xCenter = (canvas.width / scale - barcodeCanvas.width) / 2;

  // Step 6 — draw label (top)
  ctx.fillStyle = "#000";
  ctx.font = "20px Arial";
  ctx.textAlign = "center";

  if (label) {
    ctx.fillText(label, canvas.width / (2 * scale), topPadding - 10);
  }

  // Step 7 — draw barcode image (middle)
  ctx.drawImage(barcodeCanvas, xCenter, topPadding);

  // Step 8 — draw numeric code (bottom)
  ctx.fillText(code, canvas.width / (2 * scale), topPadding + barcodeHeight + 24);

  // Step 9 — store final PNG output
  generatedImg = canvas.toDataURL("image/png");

  // Step 10 — display it
  const img = document.createElement("img");
  img.src = generatedImg;
  img.style.maxWidth = "100%";

  enableLongPress(img);
  document.getElementById("output").appendChild(img);

  hideSpinner();
  enableDownloadButtons();
}

/* QR CODE */
function generateQR(code, label) {
  const tempCanvas = document.createElement("canvas");

  QRCode.toCanvas(tempCanvas, code, { margin: 2 }, () => {
    const size = tempCanvas.width;
    const finalCanvas = document.createElement("canvas");
    const scale = 2;

    finalCanvas.width = size * scale;
    finalCanvas.height = (size + 60) * scale;

    const ctx = finalCanvas.getContext("2d");
    ctx.scale(scale, scale);

    ctx.fillStyle = "#000";
    ctx.font = "20px Arial";
    ctx.textAlign = "center";

    if (label) ctx.fillText(label, size / 2, 25);
    ctx.drawImage(tempCanvas, 0, 35);
    ctx.fillText(code, size / 2, size + 55);

    generatedImg = finalCanvas.toDataURL("image/png");
    displayGeneratedImage();

    hideSpinner();
    enableDownloadButtons();
  });
}

/* DISPLAY */
function displayGeneratedImage() {
  const img = document.createElement("img");
  img.src = generatedImg;
  img.style.maxWidth = "100%";
  enableLongPress(img);

  document.getElementById("output").appendChild(img);
}

/* Download image */
function downloadImage() {
  if (!generatedImg) return;
  const a = document.createElement("a");
  a.href = generatedImg;
  a.download = "generated_code.png";
  a.click();
}

/* PDF */
async function downloadPDF() {
  if (!generatedImg) return;

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  // Load image
  const img = new Image();
  img.src = generatedImg;
  await new Promise(res => img.onload = res);

  // Convert px → mm
  const pxToMM = px => (px * 25.4) / 96;

  const imgWmm = pxToMM(img.naturalWidth);
  const imgHmm = pxToMM(img.naturalHeight);

  // IMPORTANT: Set each barcode's width so 6 fit perfectly
  const targetW = 30; // ← adjust this if needed
  const scaleFactor = targetW / imgWmm;

  const finalW = imgWmm * scaleFactor;
  const finalH = imgHmm * scaleFactor;

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  const spacing = 4;

  // FIXED: Force 6 columns
  const cols = 8;

  // Auto-compute rows based on available height
  const rows = Math.max(1, Math.floor((pageH - spacing) / (finalH + spacing)));

  let y = spacing;

  for (let r = 0; r < rows; r++) {
    let x = spacing;

    for (let c = 0; c < cols; c++) {
      pdf.addImage(img, "PNG", x, y, finalW, finalH);
      x += finalW + spacing;
    }

    y += finalH + spacing;
  }

  pdf.save("print_ready_codes.pdf");
}

/* LONG PRESS SUPPORT (touch + mouse) */
function enableLongPress(img) {
  let timer;

  const start = () => {
    timer = setTimeout(() => {
      pressedImg = img.src;
      openPopup();
    }, 650);
  };

  const cancel = () => clearTimeout(timer);

  img.addEventListener("touchstart", start);
  img.addEventListener("touchend", cancel);
  img.addEventListener("mousedown", start);
  img.addEventListener("mouseup", cancel);
}

/* POPUP */
function openPopup() {
  document.getElementById("downloadPopup").style.display = "flex";
  document.body.classList.add("popup-open");
}
function closePopup() {
  document.getElementById("downloadPopup").style.display = "none";
  document.body.classList.remove("popup-open");
}

document.getElementById("confirmDownload").onclick = () => {
  if (!pressedImg) return;
  const a = document.createElement("a");
  a.href = pressedImg;
  a.download = "generated_code.png";
  a.click();
  closePopup();
};

/* ENTER KEY */
document.getElementById("code").addEventListener("keydown", e => {
  if (e.key === "Enter") generate();
});
</script>

<!-- DOWNLOAD POPUP -->
<div id="downloadPopup" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;">
  <div style="
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    color: #000;
    width: 80%;
    max-width: 280px;
    text-align: center;
    font-size: 18px;">
    <p>Download generated image?</p>
    <button id="confirmDownload" style="
      margin-top: 10px; width: 100%; padding: 12px;
      background: #2d3136; color: #fff; border: none; border-radius: 5px;">
      Download
    </button>
    <button onclick="closePopup()" style="
      margin-top: 10px; width: 100%; padding: 12px;
      background: #777; color: #fff; border: none; border-radius: 5px;">
      Cancel
    </button>
  </div>
</div>

</body>
</html>